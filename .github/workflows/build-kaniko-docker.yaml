name: Build & Push Fetch-Repos Bot Runner image (Kaniko)

on:
  push:
    paths:
      - 'robot.yaml'
      - 'conda.yaml'
      - 'repos/fetch-repos/Dockerfile'
  pull_request:
    paths:
      - 'robot.yaml'
      - 'conda.yaml'
      - 'repos/fetch-repos/Dockerfile'
  workflow_dispatch:

env:
  IMAGE_BASE: ghcr.io/${{ github.repository_owner }}/fetch-repos-bot-runner
  CACHE_IMG:  ghcr.io/${{ github.repository_owner }}/fetch-repos-bot-runner-cache:latest
  KANIKO_CACHE_ARGS: "--cache=true --cache-copy-layers=true --cache-ttl=24h"

concurrency:
  group: kaniko-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-to-ghcr:
    runs-on: fetch-repos-bot-runner-k8s-kaniko

    container:
      image: gcr.io/kaniko-project/executor:v1.23.2-debug

    permissions:
      contents: read
      packages: write          # push to GHCR

    steps:
      - name: Build and Push Image to GHCR with kaniko
        env:
          GIT_USERNAME: ${{ github.actor }}
          GIT_PASSWORD: ${{ secrets.CR_PAT }}
        run: |
          cat <<EOF > /kaniko/.docker/config.json
          {
            "auths": {
              "ghcr.io": {
                "auth": "$(echo -n "$GIT_USERNAME:$GIT_PASSWORD" | base64 -w0)"
              }
            }
          }
          EOF

          /kaniko/executor --dockerfile="repos/fetch-repos/Dockerfile" \
            --context="${{ github.repositoryUrl }}#${{ github.ref }}#${{ github.sha }}" \
            --destination="$IMAGE_BASE:$(echo $GITHUB_SHA | head -c7)" \
            $KANIKO_CACHE_ARGS \
            --cache-repo="$CACHE_IMG" \
            --push-retry 5
