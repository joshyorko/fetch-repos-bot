name: Build and Push Fetch Repos Bot Runner Docker Image with Kaniko

on:
  push:
    paths:
      - 'robot.yaml'
      - 'conda.yaml'
      - 'repos/fetch-repos/Dockerfile'
  pull_request:
    paths:
      - 'robot.yaml'
      - 'conda.yaml'
      - 'repos/fetch-repos/Dockerfile'
  workflow_dispatch:

env:
  IMAGE: ghcr.io/${{ github.repository_owner }}/fetch-repos-bot-runner       # base ref

concurrency:
  group: kaniko-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: fetch-repos-bot-runner-k8s-kaniko
    # ‼️  Whole job runs inside Kaniko ⇒ secret-file always present
    container:
      image: gcr.io/kaniko-project/executor:v1.23.2-debug

    permissions:
      contents: read              # checkout
      packages: write             # push to GHCR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy config files (robot, conda)
        run: |
          cp robot.yaml repos/fetch-repos/
          cp conda.yaml repos/fetch-repos/

      - name: Write GHCR auth file
        env:
          GHCR_PAT: ${{ secrets.CR_PAT }}        # PAT with write:packages (+repo if private)
        run: |
          mkdir -p /kaniko/.docker
          echo '{"auths":{"ghcr.io":{"auth":"'"$(echo -n "${{ github.actor }}:${GHCR_PAT}" | base64 -w0)"'"}}}' \
          > /kaniko/.docker/config.json

      - name: Build & push SHA tag
        run: |
          /kaniko/executor \
            --dockerfile=repos/fetch-repos/Dockerfile \
            --context=./repos/fetch-repos \
            --destination=${{ env.IMAGE }}:${{ github.sha }} \
            --cache=true \
            --cache-repo=${{ env.IMAGE }}-cache:latest

      - name: Build & push latest (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          /kaniko/executor \
            --dockerfile=repos/fetch-repos/Dockerfile \
            --context=./repos/fetch-repos \
            --destination=${{ env.IMAGE }}:latest \
            --cache=true \
            --cache-repo=${{ env.IMAGE }}-cache:latest
