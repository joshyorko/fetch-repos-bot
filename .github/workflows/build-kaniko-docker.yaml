name: Build and Push Fetch Repos Bot Runner Docker Image with Kaniko

on:
  push:
    paths:
      - 'robot.yaml'
      - 'conda.yaml'
      - 'repos/fetch-repos/Dockerfile'
  pull_request:
    paths:
      - 'robot.yaml'
      - 'conda.yaml'
      - 'repos/fetch-repos/Dockerfile'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/fetch-repos-bot-runner

concurrency:
  group: kaniko-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: fetch-repos-bot-runner-k8s-kaniko
    container: { image: cgr.dev/chainguard/actions-runner:latest }  # slim base
    steps:
      - uses: actions/checkout@v4
      - name: Kaniko build
        uses: docker://gcr.io/kaniko-project/executor:v1.23.2
        env: { DOCKER_CONFIG: /kaniko/.docker }    # picked up from secret
        with:
          args: >
            --dockerfile=Dockerfile
            --context=.
            --destination=ghcr.io/joshyorko/fetch-repos-bot-runner:${{ github.sha }}
            --cache=true
            --cache-repo=ghcr.io/joshyorko/fetch-repos-bot-runner-cache:latest

      - name: Build and push latest tag (if main branch)
        if: github.ref == 'refs/heads/main'
        uses: docker://gcr.io/kaniko-project/executor:v1.23.2
        env:
          DOCKER_CONFIG: /kaniko/.docker/
        with:
          args: >
            --dockerfile=repos/fetch-repos/Dockerfile
            --context=./repos/fetch-repos
            --destination=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            --cache=true
            --cache-repo=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-cache:latest
            --cache-dir=/workspace/.kaniko/cache
            --snapshotMode=redo
            --push-retry=3

